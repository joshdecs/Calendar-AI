<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar Auto-Agent</title>
    <style>
        /* Styles CSS pour un look mobile-friendly */
        body { font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background-color: #f4f4f9; }
        #main-container { width: 90%; max-width: 500px; background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #4285F4; text-align: center; margin-bottom: 20px; }
        button { padding: 10px 20px; margin: 5px 0; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        #record-button { background-color: #DB4437; color: white; }
        #record-button:hover { background-color: #a72d22; }
        #stop-button { background-color: #F4B400; color: white; display: none; }
        #stop-button:hover { background-color: #c79000; }
        #file-upload-section, #instruction-section { margin-top: 15px; padding: 15px; border: 1px dashed #ccc; border-radius: 8px; }
        #status-message { margin-top: 20px; padding: 10px; border-radius: 8px; min-height: 40px; background-color: #eee; }
        input[type="file"] { margin-top: 10px; }
        textarea { width: 100%; height: 80px; margin-top: 10px; padding: 8px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; }
        #send-button { background-color: #0F9D58; color: white; margin-top: 20px; }
        #send-button:hover { background-color: #097d47; }
    </style>
</head>
<body>

<div id="main-container">
    <h1>ğŸ“… Agent Vocal</h1>

    <div id="file-upload-section">
        <label for="fileInput">Document ou Audio Ã  analyser (Optionnel) :</label>
        <input type="file" id="fileInput" accept="audio/*, .pdf, image/*">
    </div>

    <div id="instruction-section">
        <p>Instructions ou RequÃªte :</p>
        <textarea id="instructionText" placeholder="Ex: Planifie la rÃ©union de 10h sur ce PDF, ou : 'Rdv chez le coiffeur vendredi Ã  18h'"></textarea>
    </div>

    <div style="text-align: center; margin-top: 20px;">
        <button id="record-button">ğŸ™ï¸ Enregistrer un message vocal</button>
        <button id="stop-button">ğŸ›‘ ArrÃªter l'enregistrement</button>
    </div>

    <button id="send-button">ğŸš€ Planifier l'Ã©vÃ©nement</button>

    <div id="status-message">PrÃªt.</div>
</div>

<script>
    // *************************************************************
    // âš ï¸ REMPLACER VOTRE URL ICI !
    // *************************************************************
    const API_ENDPOINT = 'https://web-production-d5887.up.railway.app/schedule_event'; 
    
    // Ã‰lÃ©ments DOM
    const recordButton = document.getElementById('record-button');
    const stopButton = document.getElementById('stop-button');
    const sendButton = document.getElementById('send-button');
    const statusMessage = document.getElementById('status-message');
    const instructionText = document.getElementById('instructionText');
    const fileInput = document.getElementById('fileInput');

    let mediaRecorder;
    let audioChunks = [];

    // ----------------------------------------------------------------
    // 1. GESTION DE L'ENREGISTREMENT VOCAL (JavaScript)
    // ----------------------------------------------------------------

    recordButton.onclick = async () => {
        try {
            // Demande l'accÃ¨s au microphone
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm; codecs=opus' });
                const audioFile = new File([audioBlob], "voice_memo.webm", { type: 'audio/webm; codecs=opus' });
                
                // Assigner l'audio au champ de fichier invisible pour l'envoi
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(audioFile);
                fileInput.files = dataTransfer.files;

                statusMessage.textContent = "âœ… Audio enregistrÃ© et prÃªt Ã  Ãªtre planifiÃ©.";
                
                // ArrÃªter la piste du micro
                stream.getTracks().forEach(track => track.stop());
            };

            mediaRecorder.start();
            recordButton.style.display = 'none';
            stopButton.style.display = 'inline-block';
            statusMessage.textContent = "ğŸ”´ Enregistrement en cours...";

        } catch (err) {
            statusMessage.textContent = `âŒ Erreur d'accÃ¨s au micro : ${err.message}`;
            console.error(err);
        }
    };

    stopButton.onclick = () => {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            recordButton.style.display = 'inline-block';
            stopButton.style.display = 'none';
        }
    };

    // ----------------------------------------------------------------
    // 2. ENVOI DES DONNÃ‰ES Ã€ L'API FASTAPI (Upload Multimodal)
    // ----------------------------------------------------------------

    sendButton.onclick = async () => {
        const formData = new FormData();
        const instruction = instructionText.value.trim();
        const file = fileInput.files[0];

        if (!instruction && !file) {
            statusMessage.textContent = "âŒ Veuillez fournir du texte/instruction ou un fichier.";
            return;
        }

        // Ajouter l'instruction texte (mÃªme si elle est vide, nous envoyons au moins la requÃªte)
        formData.append('instruction', instruction || 'Planifie l\'Ã©vÃ©nement contenu dans le fichier.');

        // Ajouter le fichier (si prÃ©sent)
        if (file) {
            formData.append('file', file);
        }
        
        statusMessage.textContent = "â³ Envoi Ã  l'IA et planification en cours...";
        sendButton.disabled = true;

        try {
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                body: formData,
            });

            const result = await response.json();

            if (response.ok) {
                let msg = `âœ… SuccÃ¨s ! ${result.count} Ã©vÃ©nement(s) crÃ©Ã©(s).`;
                if (result.events && result.events.length > 0) {
                     msg += ` Le premier Ã©vÃ©nement est : ${result.events[0].summary}.`;
                }
                statusMessage.textContent = msg;
                instructionText.value = ''; // Nettoyer le champ aprÃ¨s succÃ¨s
                fileInput.value = ''; // RÃ©initialiser le fichier
            } else {
                statusMessage.textContent = `âŒ Erreur (${response.status}) : ${result.detail || 'Erreur inconnue.'}`;
            }

        } catch (error) {
            statusMessage.textContent = `âŒ Erreur de connexion au serveur : ${error.message}`;
            console.error('API Error:', error);
        } finally {
            sendButton.disabled = false;
        }
    };

    // Initialisation
    statusMessage.textContent = `PrÃªt. L'API est configurÃ©e pour : ${API_ENDPOINT}`;

</script>

</body>
</html>